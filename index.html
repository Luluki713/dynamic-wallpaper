<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPad 多分类动漫动态壁纸（预加载循环版）</title>

<!-- iOS Web App 全屏 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    background: #000;
  }
  #wallpaper {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    position: absolute;
    top: 0;
    left: 0;
    transition: opacity 1.5s ease-in-out, transform 20s linear;
    opacity: 0;
    transform: scale(1);
  }
</style>
</head>
<body>
<div id="wallpaper"></div>

<script>
const wallpaper = document.getElementById('wallpaper');
const intervalTime = 10000; // 每10秒切换
const preloadCount = 5; // 预加载图片数量
const categories = ['waifu', 'neko', 'shinobu']; // 可扩展分类

let preloadedImages = [];
let currentIndex = 0;

// 随机选择分类
function getRandomCategory() {
  const index = Math.floor(Math.random() * categories.length);
  return categories[index];
}

// 预加载单张图片
async function preloadImage() {
  try {
    const category = getRandomCategory();
    const response = await fetch(`https://api.waifu.pics/sfw/${category}`);
    const data = await response.json();
    const img = new Image();
    img.src = data.url;
    await new Promise(resolve => { img.onload = resolve; }); // 确保图片加载完成
    return img.src;
  } catch (err) {
    console.error('获取图片失败', err);
    return null;
  }
}

// 预加载多张图片
async function preloadImages(count) {
  preloadedImages = [];
  for (let i = 0; i < count; i++) {
    const src = await preloadImage();
    if (src) preloadedImages.push(src);
  }
}

// 切换图片函数
function changeWallpaper() {
  if (preloadedImages.length === 0) return;
  wallpaper.style.opacity = 0; // 淡出
  setTimeout(() => {
    wallpaper.style.backgroundImage = `url('${preloadedImages[currentIndex]}')`;
    wallpaper.style.opacity = 1; // 淡入
    wallpaper.style.transform = `scale(${1 + Math.random() * 0.05})`; // 轻微缩放
    currentIndex = (currentIndex + 1) % preloadedImages.length;
  }, 500);

  // 当快轮到最后一张时，异步再预加载新图片补充数组
  if (currentIndex === preloadedImages.length - 1) {
    preloadImage().then(src => {
      if (src) preloadedImages.push(src);
    });
  }
}

// 初始化
(async function init() {
  await preloadImages(preloadCount);
  changeWallpaper();
  setInterval(changeWallpaper, intervalTime);
})();
</script>
</body>
</html>
