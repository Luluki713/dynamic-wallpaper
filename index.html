<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPad 全屏 NSFW Waifu 动态壁纸</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    background: #000;
  }
  #wallpaper {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    position: absolute;
    top: 0;
    left: 0;
    transition: opacity 1.5s ease-in-out, transform 20s linear;
    opacity: 0;
    transform: scale(1);
  }
</style>
</head>
<body>
<div id="wallpaper"></div>

<script>
const wallpaper = document.getElementById('wallpaper');
const intervalTime = 10000; // 每10秒切换
const preloadCount = 5; // 初始预加载图片数量

let preloadedImages = [];
let usedImages = new Set();
let currentIndex = 0;

// 预加载单张 NSFW waifu 图片（避免重复）
async function preloadImage() {
  try {
    let attempts = 0;
    while (attempts < 10) { // 最多尝试10次避免无限循环
      const response = await fetch('https://api.waifu.pics/nsfw/waifu');
      const data = await response.json();
      const imgSrc = data.url;
      if (!usedImages.has(imgSrc)) {
        usedImages.add(imgSrc);
        const img = new Image();
        img.src = imgSrc;
        await new Promise(resolve => { img.onload = resolve; });
        return imgSrc;
      }
      attempts++;
    }
    console.warn('无法获取新的非重复图片');
    return null;
  } catch (err) {
    console.error('获取图片失败', err);
    return null;
  }
}

// 预加载多张图片
async function preloadImages(count) {
  for (let i = 0; i < count; i++) {
    const src = await preloadImage();
    if (src) preloadedImages.push(src);
  }
}

// 切换图片函数
async function changeWallpaper() {
  if (preloadedImages.length === 0) return;

  wallpaper.style.opacity = 0; // 淡出
  setTimeout(() => {
    wallpaper.style.backgroundImage = `url('${preloadedImages[currentIndex]}')`;
    wallpaper.style.opacity = 1; // 淡入
    wallpaper.style.transform = `scale(${1 + Math.random() * 0.05})`; // 轻微缩放
  }, 500);

  currentIndex++;

  // 如果数组用完，异步补充一张新图片
  if (currentIndex >= preloadedImages.length) {
    const src = await preloadImage();
    if (src) preloadedImages.push(src);
    currentIndex = 0; // 循环显示
  }
}

// 初始化
(async function init() {
  await preloadImages(preloadCount);
  changeWallpaper();
  setInterval(changeWallpaper, intervalTime);
})();
</script>
</body>
</html>

