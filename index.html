<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>iPad 全屏美女动态壁纸（无重复）</title>

<!-- iOS Web App 全屏 -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    background: #000;
  }
  #wallpaper {
    width: 100%;
    height: 100%;
    background-size: cover;
    background-position: center;
    position: absolute;
    top: 0;
    left: 0;
    transition: opacity 1.5s ease-in-out, transform 20s linear;
    opacity: 0;
    transform: scale(1);
  }
</style>
</head>
<body>
<div id="wallpaper"></div>

<script>
const wallpaper = document.getElementById('wallpaper');
const intervalTime = 10000; // 每10秒切换
const preloadCount = 10; // 初始预加载图片数量

let preloadedImages = [];
let shownImages = new Set(); // 记录已显示过的图片
let currentIndex = 0;

// 预加载单张 NSFW waifu 图片（确保不重复）
async function preloadImage() {
  try {
    let imgSrc;
    let unique = false;
    while (!unique) {
      const response = await fetch('https://api.waifu.pics/nsfw/waifu');
      const data = await response.json();
      imgSrc = data.url;
      if (!preloadedImages.includes(imgSrc) && !shownImages.has(imgSrc)) unique = true;
    }
    const img = new Image();
    img.src = imgSrc;
    await new Promise(resolve => img.onload = resolve);
    return imgSrc;
  } catch (err) {
    console.error('获取图片失败', err);
    return null;
  }
}

// 预加载多张图片
async function preloadImages(count) {
  preloadedImages = [];
  for (let i = 0; i < count; i++) {
    const src = await preloadImage();
    if (src) preloadedImages.push(src);
  }
}

// 切换图片函数
function changeWallpaper() {
  if (preloadedImages.length === 0) return;
  wallpaper.style.opacity = 0; // 淡出
  setTimeout(() => {
    const src = preloadedImages[currentIndex];
    wallpaper.style.backgroundImage = `url('${src}')`;
    wallpaper.style.opacity = 1; // 淡入
    wallpaper.style.transform = `scale(${1 + Math.random() * 0.05})`; // 缩放
    shownImages.add(src); // 记录已显示过的图片

    currentIndex = (currentIndex + 1) % preloadedImages.length;

    // 当快轮完数组时异步补充新图片
    if (currentIndex === preloadedImages.length - 1) {
      preloadImage().then(newSrc => {
        if (newSrc) preloadedImages.push(newSrc);
      });
    }
  }, 500);
}

// 初始化
(async function init() {
  await preloadImages(preloadCount);
  changeWallpaper();
  setInterval(changeWallpaper, intervalTime);
})();
</script>
</body>
</html>
